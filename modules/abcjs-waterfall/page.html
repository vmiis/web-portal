<div id="D__ID">
    <div id="container__ID" bp=576 style='display:flow-root;max-width:100%'>
        <div>
            <div w='100|45' id=left__ID style="padding:0 0 0 0">
                <div id=paper_w__ID style="width:100%;overflow:auto">
                    <div id="paper__ID" ></div>
                </div>
            </div>
            <div w='100|55' style="padding:0 0px">
                <div id=tool__ID style="height:42px;padding:3px 6px;background-color:#cbd5db;">
                    <button id="back__ID" class="button__ID">Back</button> 
                    <select id="instrument__ID">
                        <option value="acoustic_grand_piano">Acoustic grand piano</option>
                        <option value="bright_acoustic_piano">Bright acoustic piano</option>
                        
                        <option value="electric_grand_piano">Electric grand piano</option>
                        <option value="acoustic_bass">Acoustic bass</option>
                        <option value="acoustic_guitar_nylon">Acoustic guitar nylon</option>
                        <option value="acoustic_guitar_steel">Acoustic guitar steel</option>
                        
                        <option value="violin">Violin</option>
                    </select>
                    <button id="start__ID" class="button__ID">Start</button> <button id="stop__ID" class="button__ID">Stop</button>
                    <!--<button id="download__ID" class="button__ID">Download MIDI</button> 
                    <a id="midi-download"></a>-->
                </div>
                <div id=notes__ID>
                    <div name="21" class="bar__ID"></div>
                    <div name="23" class="bar__ID"></div>
                    
                    <div name="24" class="bar__ID"></div>
                    <div name="26" class="bar__ID"></div>
                    <div name="28" class="bar__ID"></div>
                    <div name="29" class="bar__ID"></div>
                    <div name="31" class="bar__ID"></div>
                    <div name="33" class="bar__ID"></div>
                    <div name="35" class="bar__ID"></div>
                    
                    <div name="36" class="bar__ID"></div>
                    <div name="38" class="bar__ID"></div>
                    <div name="40" class="bar__ID"></div>
                    <div name="41" class="bar__ID"></div>
                    <div name="43" class="bar__ID"></div>
                    <div name="45" class="bar__ID"></div>
                    <div name="47" class="bar__ID"></div>
                    
                    <div name="48" class="bar__ID"></div>
                    <div name="50" class="bar__ID"></div>
                    <div name="52" class="bar__ID"></div>
                    <div name="53" class="bar__ID"></div>
                    <div name="55" class="bar__ID"></div>
                    <div name="57" class="bar__ID"></div>
                    <div name="59" class="bar__ID"></div>
                    
                    <div name="60" class="bar__ID"></div>
                    <div name="62" class="bar__ID"></div>
                    <div name="64" class="bar__ID"></div>
                    <div name="65" class="bar__ID"></div>
                    <div name="67" class="bar__ID"></div>
                    <div name="69" class="bar__ID"></div>
                    <div name="71" class="bar__ID"></div>
                    
                    <div name="72" class="bar__ID"></div>
                    <div name="74" class="bar__ID"></div>
                    <div name="76" class="bar__ID"></div>
                    <div name="77" class="bar__ID"></div>
                    <div name="79" class="bar__ID"></div>
                    <div name="81" class="bar__ID"></div>
                    <div name="83" class="bar__ID"></div>
                    
                    <div name="84" class="bar__ID"></div>
                    <div name="86" class="bar__ID"></div>
                    <div name="88" class="bar__ID"></div>
                    <div name="89" class="bar__ID"></div>
                    <div name="91" class="bar__ID"></div>
                    <div name="93" class="bar__ID"></div>
                    <div name="95" class="bar__ID"></div>
                    
                    <div name="96" class="bar__ID"></div>
                    <div name="98" class="bar__ID"></div>
                    <div name="100" class="bar__ID"></div>
                    <div name="101" class="bar__ID"></div>
                    <div name="103" class="bar__ID"></div>
                    <div name="105" class="bar__ID"></div>
                    <div name="107" class="bar__ID"></div>
                    
                    <div name="108" class="bar__ID"></div>
                </div>
                <div id=piano__ID>
                    <div class="piano__ID" id="channel1__ID" >
                
                        <div name="21" class="key__ID white__ID"></div>
                        <div name="22" class="key__ID black__ID"></div>
                        <div name="23" class="key__ID white__ID"></div>
                        
                        <div name="24" class="key__ID white__ID"></div>
                        <div name="25" class="key__ID black__ID"></div>
                        <div name="26" class="key__ID white__ID"></div>
                        <div name="27" class="key__ID black__ID"></div>
                        <div name="28" class="key__ID white__ID"></div>
                        <div name="29" class="key__ID white__ID"></div>
                        <div name="30" class="key__ID black__ID"></div>
                        <div name="31" class="key__ID white__ID"></div>
                        <div name="32" class="key__ID black__ID"></div>
                        <div name="33" class="key__ID white__ID"></div>
                        <div name="34" class="key__ID black__ID"></div>
                        <div name="35" class="key__ID white__ID"></div>
                        
                        <div name="36" class="key__ID white__ID"></div>
                        <div name="37" class="key__ID black__ID"></div>
                        <div name="38" class="key__ID white__ID"></div>
                        <div name="39" class="key__ID black__ID"></div>
                        <div name="40" class="key__ID white__ID"></div>
                        <div name="41" class="key__ID white__ID"></div>
                        <div name="42" class="key__ID black__ID"></div>
                        <div name="43" class="key__ID white__ID"></div>
                        <div name="44" class="key__ID black__ID"></div>
                        <div name="45" class="key__ID white__ID"></div>
                        <div name="46" class="key__ID black__ID"></div>
                        <div name="47" class="key__ID white__ID"></div>

                        <div name="48" class="key__ID white__ID"></div>
                        <div name="49" class="key__ID black__ID"></div>
                        <div name="50" class="key__ID white__ID"></div>
                        <div name="51" class="key__ID black__ID"></div>
                        <div name="52" class="key__ID white__ID"></div>
                        <div name="53" class="key__ID white__ID"></div>
                        <div name="54" class="key__ID black__ID"></div>
                        <div name="55" class="key__ID white__ID"></div>
                        <div name="56"  class="key__ID black__ID"></div>
                        <div name="57" class="key__ID white__ID"></div>
                        <div name="58" class="key__ID black__ID"></div>
                        <div name="59" class="key__ID white__ID"></div>

                        <div name="60" class="key__ID white__ID"></div>
                        <div name="61" class="key__ID black__ID"></div>
                        <div name="62" class="key__ID white__ID"></div>
                        <div name="63" class="key__ID black__ID"></div>
                        <div name="64" class="key__ID white__ID"></div>
                        <div name="65" class="key__ID white__ID"></div>
                        <div name="66" class="key__ID black__ID"></div>
                        <div name="67" class="key__ID white__ID"></div>
                        <div name="68" class="key__ID black__ID"></div>
                        <div name="69" class="key__ID white__ID"></div>
                        <div name="70" class="key__ID black__ID"></div>
                        <div name="71" class="key__ID white__ID"></div>

                        <div name="72" class="key__ID white__ID"></div>
                        <div name="73" class="key__ID black__ID"></div>
                        <div name="74" class="key__ID white__ID"></div>
                        <div name="75" class="key__ID black__ID"></div>
                        <div name="76" class="key__ID white__ID"></div>
                        <div name="77" class="key__ID white__ID"></div>
                        <div name="78" class="key__ID black__ID"></div>
                        <div name="79" class="key__ID white__ID"></div>
                        <div name="80" class="key__ID black__ID"></div>
                        <div name="81" class="key__ID white__ID"></div>
                        <div name="82" class="key__ID black__ID"></div>
                        <div name="83" class="key__ID white__ID"></div>

                        <div name="84" class="key__ID white__ID"></div>
                        <div name="85" class="key__ID black__ID"></div>
                        <div name="86" class="key__ID white__ID"></div>
                        <div name="87" class="key__ID black__ID"></div>
                        <div name="88" class="key__ID white__ID"></div>
                        <div name="89" class="key__ID white__ID"></div>
                        <div name="90" class="key__ID black__ID"></div>
                        <div name="91" class="key__ID white__ID"></div>
                        <div name="92" class="key__ID black__ID"></div>
                        <div name="93" class="key__ID white__ID"></div>
                        <div name="94" class="key__ID black__ID"></div>
                        <div name="95" class="key__ID white__ID"></div>

                        <div name="96" class="key__ID white__ID"></div>
                        <div name="97" class="key__ID black__ID"></div>
                        <div name="98" class="key__ID white__ID"></div>
                        <div name="99" class="key__ID black__ID"></div>
                        <div name="100" class="key__ID white__ID"></div>
                        <div name="101" class="key__ID white__ID"></div>
                        <div name="102" class="key__ID black__ID"></div>
                        <div name="103" class="key__ID white__ID"></div>
                        <div name="104" class="key__ID black__ID"></div>
                        <div name="105" class="key__ID white__ID"></div>
                        <div name="106" class="key__ID black__ID"></div>
                        <div name="107" class="key__ID white__ID"></div>
                        
                        <div name="108" class="key__ID white__ID"></div>

                    </div>                
                </div>                
            </div>
        </div>
    </div>
    <script>
        function F__ID(m){
            $('#instrument__ID').on('change',function(){
                Soundfont.instrument(ac, 'https://gleitz.github.io/midi-js-soundfonts/FatBoy/'+$(this).val()+'-mp3.js').then(function (inst) {
                    instrument=inst;
                });
            })
			new ResizeObserver($vm.responsive).observe(container__ID);
            var cursor=0;
            var notes="";
            var abc_editor="";
            var voice_off=[];
            var voice1=true;
            var voice2=true;
            //---------------------------------------------------
            var AudioContext = window.AudioContext || window.webkitAudioContext || false; 
            var ac="";
            var instrument="";
            if(ac=="") ac=new AudioContext();
            Soundfont.instrument(ac, 'https://gleitz.github.io/midi-js-soundfonts/FatBoy/acoustic_grand_piano-mp3.js').then(function (inst) {     
                instrument=inst;
            });
            //-------------------------------
            var currentMIDI="";
            var H0=180;
            var T0=180;
            var ppq;
            var t0="";
            var t2="";
            var hT=undefined;
            var J=0;
            var I1=0;
            var I2=0;
            var Y=0;
            var tk=5; //ms per tick
            var notes="";
            var notesL;
            var n1=[];
            var n2=[];            
            var running=0;
            var step=60;
            var abc_code="";
            var visualObj="";
            var timingCallbacks="";
            var visualObjStart="";
            var abc_cursor="";
            //-------------------------------
            var platNotes=function(note){
                instrument.play(note.midi, ac.currentTime, {duration: note.durationTicks*tk/1000, gain: 2.6*note.velocity } )
                key_on(note.midi);
            }
            var platNotesOff=function(note){
                key_off(note.midi);
            }
            //-------------------------------
            var timer=function(){
                if(running==1){
                    var dt=(new Date()).getTime()-t0;
                    var ticks=dt/tk;
                    if(ticks>=T0){
                        if(timingCallbacks!="" && visualObjStart==0){
                            abc_on_start();
                            visualObjStart=1;
                            timingCallbacks.start(); 
                        }
                    }
                    if(ticks>Y){
                        Y=Y+20;
                        var yy=-step*Y/ppq;
                        $('div.note__ID').css("margin-bottom",yy+"px");
                    }
                    
                    if(I2<n2.length){
                        var n_ticks=n2[I2].ticks+T0;
                        if(ticks>=n_ticks){ 
                            platNotesOff(n2[I2]);
                            I2++;
                        }
                    }
                    else{
                        $('#stop__ID').trigger('click');
                    }
                    if(I1<n1.length){
                        var n_ticks=n1[I1].ticks+T0;
                        if(ticks>=n_ticks){ 
                            platNotes(n1[I1]);
                            I1++;       
                        }
                    }
                }
                if(I1>n1.length){
                    $('#start__ID').text("Start");
                    if(hT!=undefined){
                        clearInterval(hT);
                        hT=undefined;
                        running=0;
                    }
                }
            }
            //-------------------------------
            $('#download__ID').on('click',function(){
                if(notes!=""){
               		var a = document.getElementById("midi-download");
   	    	        var midi = ABCJS.synth.getMidiFile(notes, { midiOutputType: "encoded" })
		            a.setAttribute("href", midi)
		            a.click();
                }
            })
            //-------------------------------
            $('#start__ID').on('click',function(){
                if(currentMIDI!=""){
                    if(running==0){
                        abc_clean();
                        running=1;
                        visualObjStart=0;
                        timingCallbacks.reset();
                        $('#start__ID').text("Pause");
                        t0=(new Date()).getTime();
                        I1=0;
                        I2=0;
                        Y=0;
                        if(hT!=undefined){
                            clearInterval(hT);
                        }
                        hT=setInterval(timer,1);
                        if(timingCallbacks!="" && I1>0) timingCallbacks.start(); 
                    }
                    else if(running==1){
                        running=2;
                        $('#start__ID').text("Continue");
                        t2=(new Date()).getTime();
                        if(timingCallbacks!="") timingCallbacks.pause(); 
                    }
                    else if(running==2){
                        running=1;
                        $('#start__ID').text("Pause");
                        t0=t0+((new Date()).getTime()-t2);
                        if(timingCallbacks!="") timingCallbacks.start(); 
                    }
                }
                else alert("No MIDI file");
            })
            //------------------------------------
            $('#stop__ID').on('click',function(){
                $('#start__ID').text("Start");
                if(hT!=undefined){
                    clearInterval(hT);
                    hT=undefined;
                }
                running=0;
                if(timingCallbacks!="") timingCallbacks.stop(); 
                abc_clean();
                $("#channel1__ID div").removeClass('sel__ID');
            })
            //------------------------------------
            $('#back__ID').on('click',function(){
                window.history.go(-1);
            })
            $('#D__ID').on('hide',function(){
                $('#stop__ID').trigger('click');
            })
            //------------------------------------
            var midi_parse=function(buffer){
                $('#notes__ID div').html('');
                $('#start__ID').text("Start");
                running=0;
                if(hT!=undefined){
                    clearInterval(hT);
                    hT=undefined;
                }
                
                var midi = new Midi(buffer);
                currentMIDI=midi;
                var all_1=[],all_2=[];
                for(var i=0;i<currentMIDI.tracks.length;i++){
                    $.merge(all_1, currentMIDI.tracks[i].notes )
                    $.merge(all_2, currentMIDI.tracks[i].notes )
                }
                n1=structuredClone(all_1);
                n2=structuredClone(all_2);
                for(var i=0;i<n1.length;i++){
                    n1[i].name=all_1[i].name;
                }
                for(var i=0;i<n2.length;i++){
                    n2[i].ticks=n2[i].ticks+n2[i].durationTicks;
                    n2[i].name=all_1[i].name;
                }
                var compare=function( a, b ) {
                    if ( a.ticks < b.ticks ){
                        return -1;
                    }
                    if ( a.ticks > b.ticks ){
                        return 1;
                    }
                    return 0;
                }
                n1.sort(compare);
                n2.sort(compare);
                ppq=currentMIDI.header.ppq;
                var bpm=currentMIDI.header.tempos[0].bpm;
                tk=60000/bpm/ppq;
                T0=H0/step*ppq;
                var W=$("#notes__ID div[name='21']").width();
                for(var i=0;i<n1.length;i++){
                    var a=n1[i];
                    var num=n1[i].midi;
                    var t=n1[i].ticks;
                    var B=H0+step*(t/ppq);
                    var L=0;
                    var H=step*n1[i].durationTicks/ppq;
                    var K=n1[i].name.replace('6','').replace('5','').replace('4','').replace('3','').replace('2','').replace('1','');
                    var W1=W;
                    var black=[22,25,27,30,32,34,37,39,42,44,46,49,51,54,56,58,61,63,66,68,70,73,75,78,80,85,87,90,92,94,97,99,102,104,106];
                    if(black.indexOf(num)!=-1){
                        num++;
                        W1=W*2/3;
                        L=-W/3;
                    }
                    var bar=$("#notes__ID div[name='"+num+"']");
                    $("<div class=note__ID style='left:"+L+"px;bottom:"+B+"px;height:"+H+"px; width:"+W1+"px'>"+K+"</div>").prependTo(bar);
                }
            }
            //------------------------------------
            var key_on=function(noteNumber){         $("#channel1__ID div[name='"+noteNumber+"']").addClass('sel__ID');            }
            var key_off=function(noteNumber){        $("#channel1__ID div[name='"+noteNumber+"']").removeClass('sel__ID');         }
            //------------------------------------
            var HS=1;
            var HH=1;
            var K=1;
            var abc_removeSelection = function() {
                var lastSelection = document.querySelectorAll("#paper__ID" + " .abcjs-highlight");
                for (var k = 0; k < lastSelection.length; k++) lastSelection[k].classList.remove("abcjs-highlight");
            };
            var abc_on_start=function(){
                var svg = document.querySelector("#paper__ID" + " svg");
                abc_cursor=document.createElementNS("http://www.w3.org/2000/svg", "line");
                abc_cursor.setAttribute("class", "abcjs-cursor");
                abc_cursor.setAttributeNS(null, 'x1', 0);
                abc_cursor.setAttributeNS(null, 'y1', 0);
                abc_cursor.setAttributeNS(null, 'x2', 0);
                abc_cursor.setAttributeNS(null, 'y2', 0);
                svg.appendChild(abc_cursor);
                $("#paper_w__ID").scrollTop(0);
                const {x, y, width, height} = svg.viewBox.baseVal;
                HS=height;
                HH=$("#paper__ID").outerHeight();
                K=1;
                if(HS!=0) K=HH/HS;
            }
            var abc_clean=function(){
                abc_removeSelection();
                var svg = document.querySelector("#paper__ID" + " svg");
                if(abc_cursor!=""){
                    svg.removeChild(abc_cursor);
                    abc_cursor="";
                }
            }
            var eventCallback=function(ev) {
                if(ev==null){
                    abc_clean();
                    return;
                }
                if (ev.measureStart && ev.left === null) return; // this was the second part of a tie across a measure line. Just ignore it.
                abc_removeSelection();
                for (var i = 0; i < ev.elements.length; i++ ) {
                    var note = ev.elements[i];
                    for (var j = 0; j < note.length; j++) {
                        note[j].classList.add("abcjs-highlight");
                    }
                }
                if (abc_cursor!="") {
                    abc_cursor.setAttribute("x1", ev.left - 2+6);
                    abc_cursor.setAttribute("x2", ev.left - 2+6);
                    abc_cursor.setAttribute("y1", ev.top);
                    abc_cursor.setAttribute("y2", ev.top + ev.height);
                    var hs=$("#paper_w__ID").scrollTop();
                    if((ev.top*K-$("#paper_w__ID").height()/2)>hs){
                        $("#paper_w__ID").scrollTop(ev.top*K-100);
                    }
                }
            }
            //---------------------------------------------------
            $('#D__ID').on('load',function(){
                notes=m.input.musicnotes;
                if(notes!=undefined && notes!=""){
                    var r=ABCJS.renderAbc("paper__ID", notes,{responsive: "resize" });
                    visualObj=r[0];
                    timingCallbacks = new ABCJS.TimingCallbacks(visualObj,{eventCallback:eventCallback});
                    //$("#paper__ID").css("overflow","auto");
                    setTimeout( function(){
                        var w=$('#tool__ID').width();
                        var w1=w/52;
                        var w2=w1*0.6;
                        var wm=w2/2;
                        $('#channel1__ID div.white__ID').css('width',w1+'px')
                        $('#channel1__ID div.black__ID').css('width',w2+'px')
                        $('#channel1__ID div.black__ID').css('margin-left',-wm+'px')
                        $('#channel1__ID div.black__ID').css('margin-right',-wm+'px')

                        $('#paper_w__ID').css('height',$vm.min_height+"px");
                        //$('#paper_w__ID').css('height',($(window).height()-$('#paper_w__ID').offset().top-66)+"px");

                        $('#notes__ID').css('height',$vm.min_height-$('#tool__ID').height()-$('#piano__ID').height()-2); 
                        $('#notes__ID div.bar__ID').css('width',w1+'px');
                        $('#notes__ID').css('height',$vm.min_height-$('#tool__ID').height()-$('#piano__ID').height()-2); 
                        
                        var bs=ABCJS.synth.getMidiFile(notes, { midiOutputType: "binary" });
                        midi_parse(bs[0].buffer);

                    },1000);
                    $("#channel1__ID div").removeClass('sel__ID');
                }
            })
            //------------------------------------
        }
    </script>
    <style>
        #container__ID{
            background-color:#fff;
            padding-top:0px;
            font-family: Verdana,sans-serif;
            font-size: 15px;
            line-height: 1.5;
        }
        /*VmInclude:__CURRENT_PATH__/style.css*/
    </style>
</div>