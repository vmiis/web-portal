<div id="D__ID">
    <div id="container__ID">
		<div style="padding:30px">
			<p>
				<h3>Play piano for a remote student, teacher or friend.</h3>
			</p>
			<p>
				Connect your digital piano to a cloud group: <input placeholder="Group ID" id='group__ID'>
				<button id=connect__ID class="button__ID">Connect</button>
                <br>
                Sound: <select id=instrument__ID></select>
			</p>
		</div>
        <div style="padding:50px 180px">
            <div id="staffDiv" class="staff" style="width:200px;height:260px;display:inline-block"></div><div style="display:inline-block;padding-left:50px"><span id="cord__ID"></span></div>
        </div>
        <div id=piano__ID style="width:100%;position:fixed;bottom:0">
            <span style="margin-left:3px" id=msg__ID>No MIDI device connected.</span><br>
            <div class="piano__ID" id="channel1__ID" >
                <div name="21" class="key__ID white__ID"></div>
                <div name="22" class="key__ID black__ID"></div>
                <div name="23" class="key__ID white__ID"></div>
                
                <div name="24" class="key__ID white__ID"></div>
                <div name="25" class="key__ID black__ID"></div>
                <div name="26" class="key__ID white__ID"></div>
                <div name="27" class="key__ID black__ID"></div>
                <div name="28" class="key__ID white__ID"></div>
                <div name="29" class="key__ID white__ID"></div>
                <div name="30" class="key__ID black__ID"></div>
                <div name="31" class="key__ID white__ID"></div>
                <div name="32" class="key__ID black__ID"></div>
                <div name="33" class="key__ID white__ID"></div>
                <div name="34" class="key__ID black__ID"></div>
                <div name="35" class="key__ID white__ID"></div>
                
                <div name="36" class="key__ID white__ID"></div>
                <div name="37" class="key__ID black__ID"></div>
                <div name="38" class="key__ID white__ID"></div>
                <div name="39" class="key__ID black__ID"></div>
                <div name="40" class="key__ID white__ID"></div>
                <div name="41" class="key__ID white__ID"></div>
                <div name="42" class="key__ID black__ID"></div>
                <div name="43" class="key__ID white__ID"></div>
                <div name="44" class="key__ID black__ID"></div>
                <div name="45" class="key__ID white__ID"></div>
                <div name="46" class="key__ID black__ID"></div>
                <div name="47" class="key__ID white__ID"></div>

                <div name="48" class="key__ID white__ID"></div>
                <div name="49" class="key__ID black__ID"></div>
                <div name="50" class="key__ID white__ID"></div>
                <div name="51" class="key__ID black__ID"></div>
                <div name="52" class="key__ID white__ID"></div>
                <div name="53" class="key__ID white__ID"></div>
                <div name="54" class="key__ID black__ID"></div>
                <div name="55" class="key__ID white__ID"></div>
                <div name="56"  class="key__ID black__ID"></div>
                <div name="57" class="key__ID white__ID"></div>
                <div name="58" class="key__ID black__ID"></div>
                <div name="59" class="key__ID white__ID"></div>

                <div name="60" class="key__ID white__ID"></div>
                <div name="61" class="key__ID black__ID"></div>
                <div name="62" class="key__ID white__ID"></div>
                <div name="63" class="key__ID black__ID"></div>
                <div name="64" class="key__ID white__ID"></div>
                <div name="65" class="key__ID white__ID"></div>
                <div name="66" class="key__ID black__ID"></div>
                <div name="67" class="key__ID white__ID"></div>
                <div name="68" class="key__ID black__ID"></div>
                <div name="69" class="key__ID white__ID"></div>
                <div name="70" class="key__ID black__ID"></div>
                <div name="71" class="key__ID white__ID"></div>

                <div name="72" class="key__ID white__ID"></div>
                <div name="73" class="key__ID black__ID"></div>
                <div name="74" class="key__ID white__ID"></div>
                <div name="75" class="key__ID black__ID"></div>
                <div name="76" class="key__ID white__ID"></div>
                <div name="77" class="key__ID white__ID"></div>
                <div name="78" class="key__ID black__ID"></div>
                <div name="79" class="key__ID white__ID"></div>
                <div name="80" class="key__ID black__ID"></div>
                <div name="81" class="key__ID white__ID"></div>
                <div name="82" class="key__ID black__ID"></div>
                <div name="83" class="key__ID white__ID"></div>

                <div name="84" class="key__ID white__ID"></div>
                <div name="85" class="key__ID black__ID"></div>
                <div name="86" class="key__ID white__ID"></div>
                <div name="87" class="key__ID black__ID"></div>
                <div name="88" class="key__ID white__ID"></div>
                <div name="89" class="key__ID white__ID"></div>
                <div name="90" class="key__ID black__ID"></div>
                <div name="91" class="key__ID white__ID"></div>
                <div name="92" class="key__ID black__ID"></div>
                <div name="93" class="key__ID white__ID"></div>
                <div name="94" class="key__ID black__ID"></div>
                <div name="95" class="key__ID white__ID"></div>

                <div name="96" class="key__ID white__ID"></div>
                <div name="97" class="key__ID black__ID"></div>
                <div name="98" class="key__ID white__ID"></div>
                <div name="99" class="key__ID black__ID"></div>
                <div name="100" class="key__ID white__ID"></div>
                <div name="101" class="key__ID white__ID"></div>
                <div name="102" class="key__ID black__ID"></div>
                <div name="103" class="key__ID white__ID"></div>
                <div name="104" class="key__ID black__ID"></div>
                <div name="105" class="key__ID white__ID"></div>
                <div name="106" class="key__ID black__ID"></div>
                <div name="107" class="key__ID white__ID"></div>
                
                <div name="108" class="key__ID white__ID"></div>

            </div>                
        </div>                
    </div>
    <script>
        function F__ID(m){
        	/*VmInclude:__CURRENT_PATH__/page.js*/
			//new ResizeObserver($vm.responsive).observe(container__ID);
            var AudioContext = window.AudioContext || window.webkitAudioContext || false; 
            var ac="";
            var instrument="";
            if(ac=="") ac=new AudioContext();
            $('#instrument__ID').on('change',function(){
				var n=document.getElementById('instrument__ID').selectedIndex;
				var info=player.loader.instrumentInfo(n)
				console.log('select',n,info);
				player.loader.startLoad(audioContext, info.url, info.variable);
				player.loader.waitLoad(function () {
					console.log('done',info.variable);
					tone=window[info.variable];
					player.cancelQueue(audioContext);
				});
            })
            //-------------------------------
            var audioContext=ac;
            var tone = _tone_0000_JCLive_sf2_file;
            var midiNotes = [];            
            var player = new WebAudioFontPlayer();
            player.loader.decodeAfterLoading(audioContext, '_tone_0000_JCLive_sf2_file');
			function midNoteOn(pitch, velocity) {
				midiNoteOff(pitch);
				var envelope = player.queueWaveTable(audioContext, audioContext.destination, tone, 0, pitch, 123456789, velocity / 100);
				var note = {
					pitch: pitch,
					envelope: envelope
				};
				midiNotes.push(note);
                key_on(pitch);
			}
			function midiNoteOff(pitch) {
                key_off(pitch);
				for (var i = 0; i < midiNotes.length; i++) {
					if (midiNotes[i].pitch == pitch) {
						if (midiNotes[i].envelope) {
							midiNotes[i].envelope.cancel();
						}
						midiNotes.splice(i, 1);
						return;
					}
				}
			}
            var sel = document.getElementById('instrument__ID');
			for(var i = 0; i < player.loader.instrumentKeys().length; i++) {
				var opt = document.createElement('option');
				opt.innerHTML = ''+(i+1)+'. '+player.loader.instrumentInfo(i).title;
				sel.appendChild(opt);
			}
            //-------------------------------
            var key_on=function(noteNumber){         $("#channel1__ID div[name='"+noteNumber+"']").addClass('sel__ID');            }
            var key_off=function(noteNumber){        $("#channel1__ID div[name='"+noteNumber+"']").removeClass('sel__ID');         }
            //------------------------------------
            var myStaff;
            $('#D__ID').on('load',function(){
                $('#container__ID').css('min-height',$vm.min_height+"px");
                //------------------------------------
                setTimeout( function(){
                    var w=$('#container__ID').width();
                    var w1=w/52;
                    var w2=w1*0.6;
                    var wm=w2/2;
                    $('#channel1__ID div.white__ID').css('width',w1+'px')
                    $('#channel1__ID div.black__ID').css('width',w2+'px')
                    $('#channel1__ID div.black__ID').css('margin-left',-wm+'px')
                    $('#channel1__ID div.black__ID').css('margin-right',-wm+'px')
                },1000);
                // options for staff
                var options = {
                    id: "myStaff",
                    at: "staffDiv",
                    clef: "grand",
                    accidental: "sharp",
                    color: "#000000"
                }
                myStaff =  new Staff(options);
                myStaff.setNotes([]);
            })
            //---------------------------------------------------
			var kn=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"];
            var notes=[];
			var nT=0
            //---------------------------------------------------
            var display_chord_name=function(){
				notes.sort();
                var kk=[];
				for(var i=0;i<notes.length;i++){
					var a=(notes[i]-21)%12;
					var c=kn[a];
					kk.push(c);
				}
                var cn=Tonal.Chord.detect(kk);
                $('#cord__ID').text(cn);
			}
			//---------------------------------------------------
			setInterval( function(){
				nT++;
				if(nT>5){
					notes=[];
				}
			},1000);

            $('.key__ID').on('mousedown',function(e){
				nT=0;
                var n=$(this).attr('name');
                var v=50;
                midNoteOn(n, v);
				send('1|'+n+"|"+v);
                
                notes.push(n);
                myStaff.setNotes(notes);
				display_chord_name();
            })
            $('.key__ID').on('mouseup',function(e){
				nT=0;
                var n=$(this).attr('name');
                midiNoteOff(n);
                send('0|'+n);
                
                const index = notes.indexOf(n);
                if (index > -1) notes.splice(index, 1); 
				myStaff.setNotes(notes);
				display_chord_name();
            })
            //---------------------------------------------------
            var remote_keydown=function(n,v){
                midNoteOn(n,v);
                
                notes.push(n);
                myStaff.setNotes(notes);
				display_chord_name();
			}
			var remote_keyup=function(n){
                midiNoteOff(n);
                
                const index = notes.indexOf(n);
                if (index > -1) notes.splice(index, 1); 
                myStaff.setNotes(notes);
				display_chord_name();
			}
            //---------------------------------------------------
			function onMIDIMessage(event) {
				var data = event.data;
				var cmd = data[0] >> 4;
				var channel = data[0] & 0xf;
				var type = data[0] & 0xf0;
				var pitch = data[1];
				var velocity = data[2];
				switch (type) {
                    case 144:
                        //console.log(velocity)
                        midNoteOn(pitch, velocity);
                        send('1|'+pitch+"|"+velocity);
                        notes.push(pitch);
                        myStaff.setNotes(notes);
                        display_chord_name();
                        break;
                    case 128:
                        midiNoteOff(pitch);
                        send('0|'+pitch);
                        const index = notes.indexOf(pitch);
                        if (index > -1) notes.splice(index, 1); 
                        myStaff.setNotes(notes);
                        display_chord_name();
                        break;
				}
			}
			//--------------------------------------
			function listInputsAndOutputs(midiAccess) {
				for (const entry of midiAccess.inputs) {
					const input = entry[1];
					$('#msg__ID').text(input.name+" "+input.manufacturer+" "+input.state);
					if(input.state=="connected") startLoggingMIDIInput(midiAccess);
				}
				/*
				for (const entry of midiAccess.outputs) {
					const output = entry[1];
					console.log(`Output port [type:'${output.type}'] id:'${output.id}' manufacturer:'${output.manufacturer}' name:'${output.name}' version:'${output.version}'`);
				}
				*/
			}
			//--------------------------------------
			function startLoggingMIDIInput(midiAccess, indexOfPort) {
				midiAccess.inputs.forEach((entry) => {entry.onmidimessage = onMIDIMessage;});
			}
			//--------------------------------------
			var remote_connected=0;
			let midi = null;  // global MIDIAccess object
			function onMIDISuccess(midiAccess) {
				console.log(midiAccess);
				console.log("MIDI ready!");
				midi = midiAccess;  // store in the global (in real usage, would probably keep in an object instance)
				listInputsAndOutputs(midiAccess);
				midiAccess.onstatechange = (event) => {
					console.log(event.port.name, event.port.manufacturer, event.port.state);
					$('#msg__ID').text(event.port.name+" "+event.port.manufacturer+" "+event.port.state);
					if(event.port.state=="connected") startLoggingMIDIInput(midiAccess);
				};
			}
			//--------------------------------------
			function onMIDIFailure(msg) {
				console.error(`Failed to get MIDI access - ${msg}`);
			}
			navigator.requestMIDIAccess().then(onMIDISuccess, onMIDIFailure);
			//--------------------------------------
			var ws=null;
			var connect=function(){
				ws = new WebSocket("wss://06.vmiis.com:442");
				ws.addEventListener("open", () =>{
					console.log("We are connected");
					remote_connected=1;
					ws.send(`u:${group__ID.value}`);
				});
				ws.addEventListener('message', function (event) {
					var d=event.data;
					if(d.substring(0,2)=="n:"){
						var ss=d.substring(2).split('|');
						if(ss.length==2){
							if(ss[0]==1) remote_keydown(ss[1],ss[2])
							if(ss[0]==0) remote_keyup(ss[1])
						}
					}
				});
			}
			function send(m) {
				if(remote_connected==1){
					ws.send("n:"+m);
				}
			}
            $('#connect__ID').on('click',function(){
				group__ID.disabled = connect__ID.disabled = true;
				connect();
			})
			//--------------------------------------
        }
    </script>
    <style>
        #D__ID{
            background-color: #fff;
        }
        #container__ID{
            background-color:#fff;
            padding:0px;
            font-family: Verdana,sans-serif;
            font-size: 15px;
            line-height: 1.5;
        }
        /*VmInclude:__CURRENT_PATH__/page.css*/
    </style>
</div>