<div id="D__ID">
    <div id="container__ID">
		<div style="padding:30px">
			<p>
				<b>Play piano for a remote student, teacher or friend.</b> <span style="margin-left:30px" id=msg__ID>No MIDI device connected.</span>
			</p>
			<p>
				Connect your digital piano to a remote computer: <input placeholder="Your ID" id='your__ID'> <input placeholder="Peer ID" id='peer__ID'>
				<button id=connect__ID>Connect</button>
			</p>
		</div>
		<!--
		<p>
			<input placeholder="Message" id='message__ID' size='50'>
			<button id=send__ID _onclick="send()">Send</button>
		</p>
		-->
					  
        <div style="padding:50px 180px">
            <div id="staffDiv" class="staff" style="width:200px;height:260px"></div>
        </div>
        <div id=piano__ID style="width:100%;position:fixed;bottom:0">
            <div class="piano__ID" id="channel1__ID" >
                <div name="21" class="key__ID white__ID"></div>
                <div name="22" class="key__ID black__ID"></div>
                <div name="23" class="key__ID white__ID"></div>
                
                <div name="24" class="key__ID white__ID"></div>
                <div name="25" class="key__ID black__ID"></div>
                <div name="26" class="key__ID white__ID"></div>
                <div name="27" class="key__ID black__ID"></div>
                <div name="28" class="key__ID white__ID"></div>
                <div name="29" class="key__ID white__ID"></div>
                <div name="30" class="key__ID black__ID"></div>
                <div name="31" class="key__ID white__ID"></div>
                <div name="32" class="key__ID black__ID"></div>
                <div name="33" class="key__ID white__ID"></div>
                <div name="34" class="key__ID black__ID"></div>
                <div name="35" class="key__ID white__ID"></div>
                
                <div name="36" class="key__ID white__ID"></div>
                <div name="37" class="key__ID black__ID"></div>
                <div name="38" class="key__ID white__ID"></div>
                <div name="39" class="key__ID black__ID"></div>
                <div name="40" class="key__ID white__ID"></div>
                <div name="41" class="key__ID white__ID"></div>
                <div name="42" class="key__ID black__ID"></div>
                <div name="43" class="key__ID white__ID"></div>
                <div name="44" class="key__ID black__ID"></div>
                <div name="45" class="key__ID white__ID"></div>
                <div name="46" class="key__ID black__ID"></div>
                <div name="47" class="key__ID white__ID"></div>

                <div name="48" class="key__ID white__ID"></div>
                <div name="49" class="key__ID black__ID"></div>
                <div name="50" class="key__ID white__ID"></div>
                <div name="51" class="key__ID black__ID"></div>
                <div name="52" class="key__ID white__ID"></div>
                <div name="53" class="key__ID white__ID"></div>
                <div name="54" class="key__ID black__ID"></div>
                <div name="55" class="key__ID white__ID"></div>
                <div name="56"  class="key__ID black__ID"></div>
                <div name="57" class="key__ID white__ID"></div>
                <div name="58" class="key__ID black__ID"></div>
                <div name="59" class="key__ID white__ID"></div>

                <div name="60" class="key__ID white__ID"></div>
                <div name="61" class="key__ID black__ID"></div>
                <div name="62" class="key__ID white__ID"></div>
                <div name="63" class="key__ID black__ID"></div>
                <div name="64" class="key__ID white__ID"></div>
                <div name="65" class="key__ID white__ID"></div>
                <div name="66" class="key__ID black__ID"></div>
                <div name="67" class="key__ID white__ID"></div>
                <div name="68" class="key__ID black__ID"></div>
                <div name="69" class="key__ID white__ID"></div>
                <div name="70" class="key__ID black__ID"></div>
                <div name="71" class="key__ID white__ID"></div>

                <div name="72" class="key__ID white__ID"></div>
                <div name="73" class="key__ID black__ID"></div>
                <div name="74" class="key__ID white__ID"></div>
                <div name="75" class="key__ID black__ID"></div>
                <div name="76" class="key__ID white__ID"></div>
                <div name="77" class="key__ID white__ID"></div>
                <div name="78" class="key__ID black__ID"></div>
                <div name="79" class="key__ID white__ID"></div>
                <div name="80" class="key__ID black__ID"></div>
                <div name="81" class="key__ID white__ID"></div>
                <div name="82" class="key__ID black__ID"></div>
                <div name="83" class="key__ID white__ID"></div>

                <div name="84" class="key__ID white__ID"></div>
                <div name="85" class="key__ID black__ID"></div>
                <div name="86" class="key__ID white__ID"></div>
                <div name="87" class="key__ID black__ID"></div>
                <div name="88" class="key__ID white__ID"></div>
                <div name="89" class="key__ID white__ID"></div>
                <div name="90" class="key__ID black__ID"></div>
                <div name="91" class="key__ID white__ID"></div>
                <div name="92" class="key__ID black__ID"></div>
                <div name="93" class="key__ID white__ID"></div>
                <div name="94" class="key__ID black__ID"></div>
                <div name="95" class="key__ID white__ID"></div>

                <div name="96" class="key__ID white__ID"></div>
                <div name="97" class="key__ID black__ID"></div>
                <div name="98" class="key__ID white__ID"></div>
                <div name="99" class="key__ID black__ID"></div>
                <div name="100" class="key__ID white__ID"></div>
                <div name="101" class="key__ID white__ID"></div>
                <div name="102" class="key__ID black__ID"></div>
                <div name="103" class="key__ID white__ID"></div>
                <div name="104" class="key__ID black__ID"></div>
                <div name="105" class="key__ID white__ID"></div>
                <div name="106" class="key__ID black__ID"></div>
                <div name="107" class="key__ID white__ID"></div>
                
                <div name="108" class="key__ID white__ID"></div>

            </div>                
        </div>                
    </div>
    <script>
        function F__ID(m){
        	/*VmInclude:__CURRENT_PATH__/page.js*/
			//new ResizeObserver($vm.responsive).observe(container__ID);
            var AudioContext = window.AudioContext || window.webkitAudioContext || false; 
            var ac="";
            var instrument="";
            if(ac=="") ac=new AudioContext();
            Soundfont.instrument(ac, 'https://gleitz.github.io/midi-js-soundfonts/FatBoy/acoustic_grand_piano-mp3.js').then(function (inst) {     
                instrument=inst;
            });
            //-------------------------------
            var playNotes=function(note){
                instrument.play(note, ac.currentTime, {/*duration: note.durationTicks*tk/1000,*/ gain: 5/**note.velocity*/ } )
                key_on(note);
            }
            var playNotesOff=function(note){
                key_off(note);
            }
            //-------------------------------
            var key_on=function(noteNumber){         $("#channel1__ID div[name='"+noteNumber+"']").addClass('sel__ID');            }
            var key_off=function(noteNumber){        $("#channel1__ID div[name='"+noteNumber+"']").removeClass('sel__ID');         }
            //------------------------------------
            var myStaff;
            $('#D__ID').on('load',function(){
                $('#container__ID').css('min-height',$vm.min_height+"px");
                //------------------------------------
                setTimeout( function(){
                    var w=$('#container__ID').width();
                    var w1=w/52;
                    var w2=w1*0.6;
                    var wm=w2/2;
                    $('#channel1__ID div.white__ID').css('width',w1+'px')
                    $('#channel1__ID div.black__ID').css('width',w2+'px')
                    $('#channel1__ID div.black__ID').css('margin-left',-wm+'px')
                    $('#channel1__ID div.black__ID').css('margin-right',-wm+'px')
                },1000);
                // options for staff
                var options = {
                    id: "myStaff",
                    at: "staffDiv",
                    clef: "grand",
                    accidental: "sharp",
                    color: "#000000"
                }
                // create a new staff
                myStaff =  new Staff(options);
                // set notes (C major chord)
                myStaff.setNotes([60,64,67]);
                myStaff.setNotes([]);
                //console.log(myStaff.getNotes());
            })
            //---------------------------------------------------
            var notes=[];
			var nT=0
			setInterval( function(){
				nT++;
				if(nT>5){
					notes=[];
				}
			},1000);

            $('.key__ID').on('mousedown',function(e){
				nT=0;
                var n=$(this).attr('name');
                notes.push(n);
                myStaff.setNotes(notes);
                for(var i=0;i<notes.length;i++){
                    playNotes(notes[i]);
					send('1|'+notes[i]);
                }
            })
            $('.key__ID').on('mouseup',function(e){
				nT=0;
                var n=$(this).attr('name');
                send('0|'+n);
				playNotesOff(n);
                const index = notes.indexOf(n);
                if (index > -1) notes.splice(index, 1); 
				myStaff.setNotes(notes);
            })
			var remote_mousedown=function(n){
                notes.push(n);
                myStaff.setNotes(notes);
                for(var i=0;i<notes.length;i++){
                    playNotes(notes[i]);
                }
			}
			var remote_mouseup=function(n){
                playNotesOff(n);
                const index = notes.indexOf(n);
                if (index > -1) notes.splice(index, 1); 
                myStaff.setNotes(notes);
			}
            //---------------------------------------------------
			var remote_connected=0;
			async function receiveLoop(btn) {
				your__ID.disabled = peer__ID.disabled = btn.disabled = true;
				remote_connected=1;
				while(true) {
					try {
						// Get peer's response
						const res = await fetch(`https://ppng.io/${peer__ID.value}-${your__ID.value}`);
						// Create talk element
						//const talk = document.createElement('div');
						// Set peer's message
						var c=await res.text();
						ss=c.split('|');
						if(ss.length==2){
							if(ss[0]==1) remote_mousedown(ss[1])
							if(ss[0]==0) remote_mouseup(ss[1])
						}
						//talk.innerText = ss;//await res.text();
						// Add peer's message
						//talks__ID.appendChild(talk);
					} catch(err) {
						console.error(err);
						remote_connected=0;
					}
				}
			}
			//---------------------------------------------------
			function onMIDIMessage(event) {
				var cmd=event.data[0];
				if(cmd==144){
					nT=0;
					var n=event.data[1];
					const index = notes.indexOf(n);
					if(index==-1){
						playNotes(n);
						send('1|'+n);
					}
					notes.push(n);
					myStaff.setNotes(notes);
				} 
				else if(cmd==128){
					nT=0;
					var n=event.data[1];
					send('0|'+n);
					playNotesOff(n);
					const index = notes.indexOf(n);
					if (index > -1) notes.splice(index, 1); 
					myStaff.setNotes(notes);
				} 
			}

			//--------------------------------------
			function listInputsAndOutputs(midiAccess) {
				for (const entry of midiAccess.inputs) {
					const input = entry[1];
					$('#msg__ID').text(input.name+" "+input.manufacturer+" "+input.state);
					if(input.state=="connected") startLoggingMIDIInput(midiAccess);
				}
				/*
				for (const entry of midiAccess.outputs) {
					const output = entry[1];
					console.log(`Output port [type:'${output.type}'] id:'${output.id}' manufacturer:'${output.manufacturer}' name:'${output.name}' version:'${output.version}'`);
				}
				*/
			}
			//--------------------------------------
			function startLoggingMIDIInput(midiAccess, indexOfPort) {
				midiAccess.inputs.forEach((entry) => {entry.onmidimessage = onMIDIMessage;});
			}
			//--------------------------------------
			let midi = null;  // global MIDIAccess object
			function onMIDISuccess(midiAccess) {
				console.log(midiAccess);
				console.log("MIDI ready!");
				midi = midiAccess;  // store in the global (in real usage, would probably keep in an object instance)
				listInputsAndOutputs(midiAccess);
				midiAccess.onstatechange = (event) => {
					console.log(event.port.name, event.port.manufacturer, event.port.state);
					$('#msg__ID').text(event.port.name+" "+event.port.manufacturer+" "+event.port.state);
					if(event.port.state=="connected") startLoggingMIDIInput(midiAccess);
				};
			}
			//--------------------------------------
			function onMIDIFailure(msg) {
				console.error(`Failed to get MIDI access - ${msg}`);
			}
			navigator.requestMIDIAccess().then(onMIDISuccess, onMIDIFailure);
			//--------------------------------------
			var ws=null;
			var connect=function(){
				ws = new WebSocket("ws://06.vmiis.com:80");
				ws.addEventListener("open", () =>{
					console.log("We are connected");
					remote_connected=1;
					ws.send(`u:${your__ID.value}|${peer__ID.value}`);
				});
				ws.addEventListener('message', function (event) {
					var d=event.data;
					if(d.substring(0,2)=="n:"){
						var ss=d.substring(2).split('|');
						if(ss.length==2){
							if(ss[0]==1) remote_mousedown(ss[1])
							if(ss[0]==0) remote_mouseup(ss[1])
						}
					}
					console.log(d);
				});
			}
			function send(m) {
				if(remote_connected==1){
					ws.send("n:"+m);
				}
			}
            $('#connect__ID').on('click',function(){
				your__ID.disabled = peer__ID.disabled = connect__ID.disabled = true;
				connect();
			})

        }
    </script>
    <style>
        #D__ID{
            background-color: #fff;
        }
        #container__ID{
            background-color:#fff;
            padding:0px;
            font-family: Verdana,sans-serif;
            font-size: 15px;
            line-height: 1.5;
        }
        /*VmInclude:__CURRENT_PATH__/page.css*/
    </style>
</div>